import helper_sql_server
import os
from stat_plan import Stat_plan
from stat_sql import Stat_sql
from datetime import datetime
import time
import helper_file
import helper_regex
import helper_mysql
import config
import common_shabik_360

helper_mysql.quick_insert=True


def stat_unsub(my_date):
    
    current_date=datetime.fromtimestamp(my_date).strftime('%Y-%m-%d')
    get_current_date=lambda line:current_date

    #2011-08-13 16:02:12 GET /360/stc.jar - 84.235.75.80 HTTP/1.1 Nokia7230/5.0+(06.90)+Profile/MIDP-2.1+Configuration/CLDC-1.1 - 200 517172 34003

    oem_name='Shabik_360'
    stat_category='project_force_upgrade'
    
    db_name='raw_data_shabik_360'
    
    groups={
        'Symbian-3':[3873086,6682981,7800308,8067252,8117948,8621508,8677109,8798962,10438050,11018983,11447262,11665736,11701411,11804874,11859799,12013545,12102127,12193399,12430854,12449443,12477887,12552008,12589085,12649630,12767884,12783780,12808937,12823394,12848834,12877073,12881568,12882018,12889487,12891669,12899136,12915780,12928646,12950150,12980034,13002574,13018814,13071173,13084119,13121708,13194823,13241255,13251528,13266437,13330407,13342474,13349464,13352990,13418691,13436397,13482296,13615032,13869800,13920125,14156314,14185781,14202449,14231051,14324938,14443050,14545934,14598287,17994811,18001666,18033445,18035831,18039424,18040468,18064927,18069213,20873105,20889760,20893031,21176191,21194592,21235633,21253402,21254213,21284955,21323194,21324907,22579780,22783807,22807336,22812091,26685077,26685100,26694537,26967891,26972802,26988526,27001562,27008837,27036842,27038933,27177028,27204678,27208680,27232139,27238596,27270219,27292930,27308607,27331636,28575612,28580987,28582115,28618760,28684807,29280207,29295312,29494307,29511688,29560685,29573515,29576430,29765871,29768450,29790794,29848198,29855661,29865131,29887887,29906353,29970499,29982756,29986614,29993547,30004299,30008940,30088484,30119508,30139439,30173091,30221768,30236767,30242343,30243776,30255003,30270032,30279935,30293924,30353509,30376774,30382172,30395008,30404689,30490111,30556489,30591796,30600616,30616545,30620160,30624255,30625110,32963777,33012915,33020116,33041832,33041883,33055322,34856869,34863652,34867626,34867724,34882543,34914046,34914848,34920286,34927076,34980440,34987170,35000714,35027170,35049600,35121453,35123281,35123947,35124050,35138733,35144905,35148164,35232488,35233676,35236327,35245204,35258337,35278134,35279028,35414996,35449449,35453278,35472287,35481407,35485512,35512223,35521588,35531528,35542752,35598276,35601052,35601055,35602429,35602900,35613281,35613531,35622079,35630521,35630896,35636736,35647496,35650813,35653160,35655039,35682110,35684795,35689456,35703178,35710355,35714628,35718645,35720104,35723103,35723154,35737212,35746411,35755553,35760957,35766307,35780820,35783976,35806422,35819687,35824111,35855198,35864019,35882375,35887274,35920275,39991131,39997579,40002104,40012186,40012647,40024167,40032514,40052089,40052190,40069274,40072006,40075497,40086399,40088594,40091711,40104005,40126791,40139841,40156532,40169036,40171059,40180945,40208487,40228746,40258586,41407390,41517470,41518147,41519502,41528218,41566005,41568667,41574631,41574806,41618180,41635950,41660662,41743777,41835781,41915315,41923987,41969872,42006199,42128919,42132389,42139601,42173508,42190458,42193007,42193140,42210273,42215791,42238403,42246156,42252268,42269551,42314756],
        'Symbian-5':[7880276,8795316,10959853,11221077,11221127,11622621,11664066,11701396,11710817,11785619,12028667,12090541,12604288,12621921,12692856,12753418,12790979,12804153,12810623,12818578,12826423,12857503,12861921,12863110,12873611,12883532,12884364,12887697,12887959,12905583,12909519,12921081,12950350,12975286,12976174,13017522,13032304,13037870,13090002,13146471,13150456,13158252,13220967,13237175,13240917,13242111,13245877,13267067,13271319,13293461,13338391,13345419,13346395,13422417,13449391,13503244,13540061,13555760,13788105,13790527,13865113,13987701,14300779,14406363,14550439,14559898,18046156,20868773,20881890,20888096,20921094,21152300,21172565,21200215,21232638,21266081,21314276,21324851,21465298,22561001,24754505,26365479,26382188,26386494,26695751,26706886,26972177,26977914,26983817,26985824,27047644,27048330,27169434,27170864,27180802,27202255,27230358,27255143,27323028,28598558,28698427,29128933,29139673,29145234,29146981,29308052,29517919,29540011,29567780,29756311,29783586,29794196,29824129,29853973,29965685,29983794,30001712,30007767,30017109,30033308,30098328,30106133,30137495,30170837,30182979,30187244,30236152,30263312,30279056,30293582,30303909,30323787,30410249,30453974,30479234,30486167,30501201,30504113,30537766,30538395,30586439,30592035,30621231,31537878,32992166,33017393,33051592,33060693,34825221,34849895,34857289,34863623,34908250,34909654,34919781,34981543,34983577,34985334,35011399,35036166,35048414,35094505,35106364,35112634,35118489,35214306,35219399,35226974,35232604,35243335,35263635,35275390,35280847,35426744,35428754,35430195,35433118,35472636,35475267,35475688,35476996,35480284,35483397,35484509,35488385,35503882,35511399,35542110,35544575,35554883,35565384,35569459,35578977,35588001,35602904,35613006,35631347,35633049,35647553,35649555,35652965,35662991,35665968,35671009,35682551,35701070,35713332,35724407,35732585,35736161,35740333,35744214,35748927,35751557,35753722,35758215,35768011,35793519,35852149,35857140,35867491,35868458,35871618,35874141,35893818,35894194,35896626,35905913,35910181,35911558,35914822,35920547,39520542,40003894,40010851,40014097,40015239,40015805,40019766,40042184,40049539,40050666,40075277,40083548,40084767,40093992,40097746,40101260,40112613,40115281,40124739,40125247,40150904,40152472,40156297,40165448,40167487,40168612,40171715,40173478,40182387,40235073,40251055,41497858,41506889,41515071,41517871,41518354,41548814,41550671,41562508,41570426,41583528,41589145,41589194,41593483,41601488,41645497,41666573,41667660,41891761,41935709,41940567,41956645,42017136,42051093,42057900,42083644,42086190,42123520,42167015,42172517,42199858,42213118,42220139,42285436,42287234,42288750,42304026,42320291],
        'BlackBerry':[3747660,6638299,6661402,6816246,7352309,10334981,10522158,10608698,10918186,11142471,11150002,11476310,11533093,11597507,11647065,11654732,11670598,11695157,11710497,11826228,11868013,11968510,12144805,12214435,12249829,12275188,12495847,12511753,12592765,12637301,12716739,12732904,12765135,12812689,12819384,12827397,12861190,12880817,12897219,12909267,12910521,12962756,12974100,13025083,13042487,13112204,13117276,13129471,13129823,13154206,13240239,13248197,13320312,13329618,13333616,13381091,13401573,13424596,13427292,13451345,13456659,13612952,13655597,13737330,13887355,13958235,14080637,14412971,14465396,14541292,14609729,15979875,17983112,18016878,18018963,18036727,18067080,20885961,20927462,21208947,21224801,21232364,21237922,21243491,21464571,22574264,22577144,22782615,22805903,26344982,26348390,26354073,26684466,26691905,26701365,26717382,26990343,27004860,27029979,27175409,27227921,27276331,27279454,27290581,27311192,27318194,28567734,28589118,28593007,28607671,28630151,29048861,29148364,29238223,29244703,29281522,29500724,29546869,29562199,29730426,29732622,29791197,29861675,29872041,29885794,29957841,29979963,30040486,30080502,30300413,30347165,30352018,30364891,30376453,30435214,30450685,30518399,30519689,30532270,30583345,30601533,30601928,32966524,32995786,33004867,33033276,33035326,34790912,34808471,34833480,34834150,34841349,34850481,34894682,34936752,34998350,34998891,35019030,35038418,35076265,35078842,35080706,35080760,35083495,35098099,35146710,35157753,35160496,35160803,35163696,35169227,35171748,35178776,35213376,35222358,35238201,35259574,35264781,35267223,35273741,35278138,35279334,35320922,35430139,35441051,35442940,35447978,35461834,35471530,35472549,35475175,35476147,35481222,35484430,35486022,35505387,35524571,35553826,35565245,35576348,35578572,35579774,35593516,35604324,35643692,35646465,35663346,35673981,35685575,35688262,35689547,35690770,35696044,35700716,35703891,35724725,35743860,35752418,35758357,35766284,35773958,35783427,35793661,35836239,35843725,35843894,35851747,35888894,35890333,35898256,35906090,35912210,39994927,40014203,40027768,40046222,40050466,40052690,40054329,40057413,40060595,40062398,40065026,40075456,40080479,40095989,40111161,40112070,40131495,40135835,40143992,40147684,40151884,40161257,40162397,40172327,40188375,40190712,40197696,40214850,40222207,40233830,40241643,41528809,41537763,41547685,41548256,41577970,41581885,41582379,41590283,41600162,41600424,41606060,41619898,41646754,41663297,41786366,41906533,41917021,41989635,42053069,42057695,42082004,42097339,42107550,42108167,42118493,42143557,42188806,42189978,42195344,42202400,42234107,42235169,42242543,42261785,42285909,42289901,42307877],
        'JME':[3290445,3636038,6838067,7827611,8550591,8780215,11399583,11593403,11623656,11693574,11753626,11880430,12042097,12104548,12359363,12483861,12546569,12610319,12756697,12800499,12813847,12827782,12846770,12851278,12908507,12919886,12934498,12935298,12942709,12971289,12993010,13009103,13073434,13087084,13094682,13098660,13099636,13152648,13175077,13238814,13385361,13420813,13445877,13457267,13498617,13542721,13547219,13618723,13638090,14158881,14195241,14199105,14437385,18030300,20862718,20934336,21178975,21271559,21276598,21289780,21377340,21465074,26678924,26691040,26708095,26717470,26985680,26999454,27176449,27182383,27270648,27331361,28567650,28574173,28593970,28594127,28633926,28698601,29139992,29238883,29522511,29775683,29775932,29779314,29813028,29826814,29827002,29827308,29904507,29968352,30005394,30071069,30131076,30142545,30191718,30217445,30221843,30232781,30283568,30295143,30319466,30343494,30358959,30371362,30438818,30444752,30472418,30472521,30480906,30486974,30493077,30496135,30521429,30522904,30549184,30587716,30605222,30607266,30607697,32979694,33013252,33013256,33014316,33035900,33044151,33059950,34784072,34841511,34843806,34866737,34869274,34883123,34886265,34924066,34929098,34934917,34950559,34955766,34962363,34979301,34986611,34997885,35000622,35004989,35021008,35021598,35032913,35054886,35072857,35088789,35097085,35155631,35161232,35167212,35183711,35191270,35195349,35234885,35246438,35251595,35254687,35272496,35348434,35437904,35439969,35441589,35441617,35447150,35474171,35492102,35520832,35521812,35528184,35531653,35543917,35575594,35580526,35581025,35586906,35601733,35610424,35619222,35624610,35632881,35635117,35638585,35646321,35651811,35660987,35665095,35671583,35673274,35686071,35687898,35691128,35699043,35704790,35705013,35712967,35715525,35717765,35722372,35725100,35726377,35735185,35736172,35737198,35744105,35749615,35751088,35755730,35761326,35765316,35788086,35790499,35834309,35905628,35910445,35914304,35916797,35921480,35924829,35928294,40000677,40015230,40018463,40022338,40023043,40024010,40027326,40054016,40055432,40059955,40067126,40068317,40070058,40082122,40082152,40086165,40093537,40102798,40119653,40135893,40139152,40139297,40159106,40168771,40168816,40176693,40200792,40214613,40237000,40240758,40249646,40251318,40259016,40259813,40263501,41491917,41492889,41495468,41499829,41501977,41517249,41520224,41535930,41546267,41568127,41569926,41570055,41575985,41579394,41583289,41585365,41589258,41600085,41633641,41638215,41640571,41656046,41691858,41759987,41791046,41827661,41847436,41876129,41945462,42011185,42027785,42098409,42109064,42131747,42133620,42176522,42192654,42238576,42248648,42253146,42258463,42307578],
        
        '2_Symbian-3':[7511814,8273241,8413373,11077855,11734548,11824149,11909056,12225993,12256470,12390555,12685257,12718618,12771192,12773654,12808251,12822954,12870528,12923474,12948406,12959413,12973382,12980050,12990086,13018018,13066504,13067119,13086376,13086422,13097875,13113044,13180256,13201086,13223725,13232835,13243277,13343006,13380634,13398842,13423234,13456498,13457616,13587430,13639243,13709195,13731927,13950513,13969772,14069186,14076430,14103000,14281955,14290322,14353364,14378240,14411998,14607859,15804962,18026990,18027827,18053654,20065735,20664513,21154070,21178674,21183477,21192540,21246914,21262568,21285265,21308404,21465770,22570765,22604447,22814394,26347324,26676425,26679961,26683332,26702927,26706797,26737289,26970563,26997034,27022408,27039791,27044063,27191986,27202761,27203406,27211901,27222601,27287107,27301771,27333381,28616303,28625201,28647236,29046852,29137647,29239841,29257342,29266232,29473762,29484713,29499245,29776874,29777624,29794576,29794587,29824834,29826528,29836204,29840010,29850154,29862183,29893535,29970465,29989277,30056115,30085814,30145180,30146259,30148151,30155658,30170607,30176577,30255661,30262729,30280568,30321849,30328281,30328667,30344584,30365777,30373705,30383343,30394134,30487225,30503892,30505633,30506976,30521683,30541655,30547297,30572491,30603186,32966529,32997925,33015566,33033806,33040056,33046538,34783471,34788524,34812673,34813798,34824926,34826544,34850644,34880407,34888252,34899699,34914148,34926189,34928177,34928389,34957676,34985790,35022248,35076053,35122412,35129819,35134744,35136333,35141009,35145022,35170091,35187223,35197873,35207677,35207823,35208939,35214883,35225091,35256299,35259897,35264649,35272768,35432653,35443690,35453304,35480498,35498067,35504738,35508624,35527018,35532128,35533113,35567261,35575528,35578756,35585659,35597287,35603121,35609043,35612429,35637974,35639472,35639775,35655201,35662906,35663787,35673843,35674826,35692555,35693071,35702531,35707038,35727010,35728903,35733296,35736788,35742564,35749567,35761989,35765480,35776367,35777011,35784111,35787241,35788485,35814789,35839871,35856993,35875033,35881183,35882661,35889343,35897322,35899678,35913850,35922413,39995760,40001973,40015055,40029523,40034709,40036477,40044595,40049402,40072471,40076047,40081837,40086548,40095265,40110763,40114318,40131558,40134554,40135127,40147251,40156815,40160609,40164156,40167534,40169517,40188686,40196884,40201447,40208381,40244381,40245004,40255359,41491083,41497736,41500030,41533553,41549181,41573221,41578806,41611907,41635318,41637246,41638291,41638770,41661592,41698471,41741837,41749639,41836725,41869402,42006860,42044729,42078753,42126427,42188750,42191264,42208945,42249169,42269487],
        '2_Symbian-5':[3695978,3954350,7753873,7880144,8148520,10842459,11670419,11698567,11884933,11912374,12325290,12529496,12558768,12659880,12662768,12760822,12775982,12812473,12850141,12859955,12871345,12881975,12905310,12921351,12945256,12945528,12970555,12986147,12987839,13015935,13033441,13055627,13066110,13122419,13137698,13145317,13149761,13188550,13199624,13322670,13335315,13345886,13409220,13453729,13454956,13509281,13633739,14049325,14108942,14150861,14162678,14295257,14501694,14534404,18004058,19225661,20882232,21198856,21216157,21247226,21289322,21292616,21312375,21315457,22766563,26119087,26359294,26375534,26387098,26391955,26395835,26677496,26686699,26693415,26695780,26708523,26994502,26997515,27028587,27031278,27036046,27038202,27050394,27239007,27317705,27317767,28597871,28649171,28665102,28683361,29134638,29137058,29147742,29246332,29250969,29294980,29491970,29553353,29740653,29768455,29931288,29983582,29989066,29989269,29992560,30006746,30009108,30017655,30069459,30099055,30152717,30219617,30250140,30315879,30343773,30351422,30351425,30387031,30389421,30396977,30426762,30452536,30535849,30540260,30564233,30581119,32970605,32986380,33013445,33018267,33055317,33057243,33058083,33060848,34816155,34819774,34867382,34957804,34978273,34980215,35026461,35048111,35049918,35065158,35083390,35103012,35106728,35113652,35119456,35140006,35145540,35149934,35162710,35212581,35226588,35226989,35232959,35237045,35240551,35241277,35254612,35258773,35259488,35260438,35267232,35272743,35280995,35351576,35430699,35433493,35434454,35439729,35452085,35452165,35452605,35470694,35479900,35488596,35499600,35503945,35504491,35511811,35521456,35525349,35531549,35534763,35548883,35557379,35557993,35585845,35591815,35592156,35599684,35607285,35611711,35647439,35647551,35651015,35667147,35679190,35683591,35684021,35695937,35698546,35706565,35708565,35713244,35714445,35719821,35721632,35727407,35733037,35736301,35743010,35751032,35754000,35757422,35763100,35768294,35774529,35783099,35789130,35801198,35837688,35850197,35850422,35860199,35861002,35862761,35863152,35875161,35878103,35880214,35890348,35893718,35914755,35921449,35936525,40000353,40021463,40021813,40033364,40062891,40076918,40079306,40082114,40084524,40089576,40090266,40101570,40102009,40109707,40115598,40116881,40124072,40155041,40155509,40165378,40167868,40173027,40180073,40219019,40234537,40255676,41503784,41509695,41514085,41520104,41527290,41559464,41566292,41574884,41584452,41610536,41617230,41638229,41652418,41660070,41670633,41794875,41804148,41881015,41893357,41912445,41958297,42003177,42044132,42050972,42055321,42119475,42135464,42147721,42176479,42182252,42192715,42196547,42252456,42294305,42309274,42340443,],
        '2_BlackBerry':[8053716,8069578,8247190,8439094,10608218,10829891,10929504,11127688,11438964,11606445,11693991,11886626,12304198,12339730,12369375,12482638,12697816,12742204,12762338,12768107,12771942,12824645,12829564,12850530,12863121,12877357,12882327,12900682,12915719,12931531,13012239,13015560,13055374,13055622,13060889,13062626,13063520,13065354,13120684,13144203,13145252,13151425,13161299,13169783,13220365,13222496,13240234,13275763,13302742,13328435,13385455,13411996,13420122,13611272,13629856,13723598,14061129,14107035,14114245,14178932,14214489,14318258,14325867,14366853,14600102,18008537,18044661,18066792,21148283,21162518,21177520,21292808,21299062,21308368,21314489,22794724,22800196,26348967,26361191,26369712,26375424,26375850,26734643,26999296,27032267,27044891,27180529,27185438,27189645,27191753,27206713,27276017,27279998,27286050,27303482,27307087,27313291,27315424,28598789,28649595,28668166,28668359,29270701,29526268,29546767,29546768,29577721,29780013,29804799,29904235,29968316,29998868,30009738,30063090,30098909,30144204,30186947,30209822,30259445,30296742,30314059,30327099,30338190,30348662,30513782,30515571,30552604,30559615,30559907,30576498,30591132,30610588,30618929,32989358,33023368,33056395,34797513,34815436,34870402,34874936,34909472,34914860,34916979,34934713,34991562,34997009,35039375,35110305,35113221,35128810,35131828,35197820,35222435,35222839,35224736,35239475,35244760,35259611,35262422,35275155,35275270,35302614,35347350,35452382,35472740,35473579,35479827,35484723,35485016,35485121,35487879,35494442,35499213,35502538,35533334,35535377,35540737,35542582,35548441,35551466,35559201,35563741,35566307,35610661,35611660,35614006,35623046,35623661,35636805,35647558,35655130,35661722,35664667,35665560,35676277,35681888,35683307,35685391,35699518,35721413,35730090,35746585,35786029,35795252,35830488,35836546,35842343,35860846,35873871,35885906,35886071,35902452,35902941,35904643,35908989,35913351,35913816,35915591,35920240,38690312,39988673,39998325,40006069,40012705,40015275,40040587,40044306,40048416,40049241,40060635,40063284,40073666,40077465,40084122,40085178,40107133,40133195,40137816,40142387,40143653,40144875,40145608,40149355,40157081,40163864,40166492,40168010,40172954,40183593,40189788,40195442,40197409,40212523,40220565,40221869,40227108,40245244,40246305,40257339,40260747,41502720,41508274,41514956,41522591,41544210,41552289,41565531,41575722,41576898,41596873,41598475,41601392,41617857,41625198,41645475,41647591,41655618,41663771,41732019,41819952,41865414,41914288,41946430,41979216,42022825,42026432,42053320,42074160,42099034,42104864,42127749,42130774,42133470,42145745,42189082,42225476,42226966,42245549,42281724,42316341,],
        '2_JME':[7422336,7473529,7789066,7882826,7930910,10941687,11325776,11568292,11621893,11651480,11678603,11707198,12192410,12239855,12634739,12689515,12764586,12804099,12821922,12871616,12878221,12881751,12885710,12957280,13035928,13312664,13401202,13409208,13438933,13508187,13763539,13934462,14429832,20856054,20873673,20905897,20933823,21206360,21206856,21227449,21247729,22574968,22805304,23786689,26381775,26689367,26693853,26966462,27225680,27234016,27234228,27237568,27271899,28614099,28618549,28632288,28666503,28682764,28687148,29140023,29243133,29263040,29273102,29273352,29292913,29295809,29484791,29543073,29544354,29744392,29763717,29831514,29837724,29904291,29919299,29960157,29971652,30073714,30101184,30161466,30213680,30238535,30259955,30272415,30280758,30296838,30351118,30412730,30433308,30476346,30508852,30539301,32993403,33008428,33037903,33061083,34784335,34806402,34832688,34859646,34879676,34887997,34918697,34919799,34948101,34951470,34963363,35022055,35048390,35051448,35058443,35071312,35122344,35133683,35160953,35173243,35195370,35207182,35227657,35236525,35253570,35255383,35256228,35277845,35279922,35428264,35439403,35447989,35501764,35502484,35520181,35528580,35545898,35552916,35554396,35557226,35559897,35565983,35567876,35575523,35576734,35581038,35583820,35598731,35598950,35599619,35609373,35622968,35625125,35626391,35628815,35628834,35630963,35632713,35634706,35638801,35642398,35651201,35660905,35661713,35667233,35671366,35672333,35673316,35675476,35681863,35683807,35690257,35694060,35694687,35695846,35703278,35706071,35711292,35712310,35717708,35731619,35734231,35738373,35754599,35771190,35774570,35777472,35798621,35827110,35831979,35835323,35840725,35853324,35863913,35865770,35870997,35881960,35882943,35884468,35884814,35885078,35889866,35893814,35898424,35898676,35899438,35904987,35908334,35914490,35928949,35930707,38450172,39996166,39999851,40002714,40005802,40006027,40018395,40026205,40041909,40048445,40056468,40057182,40064750,40067434,40073620,40078273,40082875,40082883,40088881,40097655,40103126,40103740,40104205,40112444,40112609,40115284,40134038,40140553,40142838,40150142,40155792,40166502,40179757,40181343,40196972,40227413,40239249,40244068,40244141,40260044,41505911,41514974,41518774,41525228,41528766,41532873,41535172,41543407,41581280,41581284,41582445,41585298,41586344,41590773,41603949,41604348,41621103,41643232,41661018,41679228,41685242,41687457,41691384,41699076,41762692,41803152,41817184,41827432,41847832,41865386,41943748,41952938,41964019,41976807,42047524,42071818,42077498,42102309,42136715,42187717,42188731,42191172,42193132,42195413,42213671,42244022,42245617,42247574,42248386,42288905,42305036,42316798,42319163,],
    }

    unsubbed_user={}

    for group_name,ids in groups.iteritems():
        
        #calculate unsub

        sql=r'''
        
        SELECT distinct [msisdn]
        FROM [stc_integral].[dbo].[accounts] with(nolock)
        where [msisdn] in (
            select [phone]
            from [DB85].[mozone_user].[dbo].[profile] with(nolock)
            where user_id in (
                %s
            )
        ) and [is_deleted]=1

        ''' % (','.join([str(id) for id in ids]))
    
        unsubbed_user[group_name]=helper_sql_server.fetch_set(config.conn_mt,sql)
        unsubbed_user_count=len(unsubbed_user[group_name])

        key='total_unsub_user_unique'
        helper_mysql.put_raw_data(oem_name,stat_category,key,group_name,unsubbed_user_count,db_name,current_date)
        helper_mysql.put_collection(collection=unsubbed_user[group_name],oem_name=oem_name,category=stat_category,key=key,sub_key=group_name,table_name=db_name,date=current_date)
    
        
    
    #check download

    def get_group_name(monet_id):
        for group_name,ids in groups.iteritems():
            if int(monet_id) in ids:
                return group_name
        return 'Unknown'    
    
    stat_plan=Stat_plan()
    
    stat_sql=Stat_sql(oem_name=oem_name,stat_category=stat_category, \
                                        select_count_distinct_collection={'download_monet_id':r'src=upgrade&u=(\d+)'},\
                                        where={'force_upgrade':'(s)rc=upgrade&u=\d+'}, \
                                        group_by={'daily':get_current_date, \
                                                  'by_group':lambda line:get_group_name(helper_regex.extract(line,r'src=upgrade&u=(\d+)'))},
                                        db_name=db_name)

    stat_plan.add_stat_sql(stat_sql)

    start_time=1328781977

    for t in range(start_time,int(my_date),3600*24):

        stat_plan.add_log_source_list(helper_regex.translate_iis_website_hourly_log_path(
                                            t,r'\\192.168.0.100\W3SVC1213381794\ex%(date)s%(hour)s.log', \
                                            timezone_offset_to_sg=config.timezone_offset_shabik_360,date_format='%y%m%d'))

        stat_plan.add_log_source_list(helper_regex.translate_iis_website_hourly_log_path(
                                            t,r'\\192.168.0.175\W3SVC1213381794\ex%(date)s%(hour)s.log', \
                                            timezone_offset_to_sg=config.timezone_offset_shabik_360,date_format='%y%m%d'))

    stat_plan.run()    

    no_download_collection={}

    for k,v in groups.iteritems():
        
        download_collection=helper_mysql.get_raw_collection_from_key(oem_name='Shabik_360',category='project_force_upgrade',key='force_upgrade_by_group_daily_download_monet_id_unique',sub_key=k,date=current_date,table_name=db_name,db_conn=None)

        original_collection=set([str(i) for i in v])
        no_download_collection_temp=original_collection-download_collection
        
        no_download_msisdn_collection=helper_sql_server.fetch_dict_map_to_collection(no_download_collection_temp,sql_template=r'''

        select 
        phone,0
        from db85.mozone_user.dbo.profile with(nolock)
        where user_id in (%s)
        --and left(phone,1)='+'

        ''',conn_config=config.conn_stc,step=1000).keys()

        no_download_collection[k]=no_download_collection_temp

        key='force_upgrade_by_group_daily_non_download_msisdn_unique'
        helper_mysql.put_raw_data(oem_name,stat_category,key,k,len(no_download_msisdn_collection),db_name,current_date)
        helper_mysql.put_collection(collection=no_download_msisdn_collection,oem_name=oem_name,category=stat_category,key=key,sub_key=k,table_name=db_name,date=current_date)


    
    # check moagent activity

    start_time=1328781977

    moagent_active_collection=set([])

    for t in range(start_time,int(my_date),3600*24):

        d=datetime.fromtimestamp(t).strftime('%Y-%m-%d')

        moagent_active_collection_temp=helper_mysql.get_raw_collection_from_key(oem_name='Shabik_360',category='moagent', \
                                        key='app_page_daily_visitor_unique',sub_key='', \
                                        date=d,table_name=db_name,db_conn=None)

        moagent_active_collection|=moagent_active_collection_temp

    for group_name,ids in groups.iteritems():

        active_count=len(set([str(i) for i in ids]) & moagent_active_collection)
        key='total_active_user_unique'
        helper_mysql.put_raw_data(oem_name,stat_category,key,group_name,active_count,db_name,current_date)


        download_collection=helper_mysql.get_raw_collection_from_key(oem_name='Shabik_360',category='project_force_upgrade',key='force_upgrade_by_group_daily_download_monet_id_unique',sub_key=group_name,date=current_date,table_name=db_name,db_conn=None)

        no_login_user=download_collection-moagent_active_collection
        no_login_user=set([str(i) for i in no_login_user])

        no_login_user_msisdn_collection=helper_sql_server.fetch_dict_map_to_collection(no_login_user,sql_template=r'''select 
        phone,0
        from db85.mozone_user.dbo.profile with(nolock)
        where user_id in (%s)
        and left(phone,1)='+'
        
        ''',conn_config=config.conn_stc,step=1000).keys()

        key='total_download_non_active_user_msisdn_unique'
        helper_mysql.put_raw_data(oem_name,stat_category,key,group_name,len(no_login_user_msisdn_collection),db_name,current_date)
        helper_mysql.put_collection(collection=no_login_user_msisdn_collection,oem_name=oem_name,category=stat_category,key=key,sub_key=group_name,table_name=db_name,date=current_date)


    print 'unsubbed_user:',unsubbed_user

if __name__=='__main__':

    #print time.time()-3600*24*1
    #exit()
    
    for i in range(config.day_to_update_stat,0,-1):
        my_date=time.time()-3600*24*i
        stat_unsub(my_date)
